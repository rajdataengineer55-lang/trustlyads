rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      // Check if the user is authenticated and has the 'admin' custom claim.
      return request.auth != null && request.auth.token.admin == true;
    }

    match /offers/{offerId} {
      allow read; // Anyone can read public offers.
      allow create, update, delete: if isAdmin(); // Only admins can manage offers.
    }
    
    match /stories/{storyId} {
      allow read; // Anyone can read stories.
      allow create, update, delete: if isAdmin(); // Only admins can manage stories.
    }

    match /followers/{followerId} {
      // Users can only manage their own follow status.
      allow read, create, delete: if request.auth != null && request.auth.uid == followerId;
      // For privacy, disallow listing all followers.
      allow list: if false;
    }
    
    // Grant full access to the Onboarding Lobby for admins.
    match /onboardedUsers/{userId} {
      allow read, write: if isAdmin();
    }
  }
}
